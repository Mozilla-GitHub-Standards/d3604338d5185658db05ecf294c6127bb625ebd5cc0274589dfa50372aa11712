{% extends "config/base.html" %}
{% load url from future %}
{% load custom_filters %}
{% block scripts %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/details.css"/>
{% endblock %}

{% block title %}Mozilla ISP Database{% endblock %}
{% block bodystart %}

<script type="text/javascript">
$(document).ready(function() {
  $("#show").click(function() {
    $(this).hide();
    $(this).parent().children('.comment_list').show('fast');
  })
  $("#add").click(function() {
    $(this).hide();
    $(this).parent().children('.comment_form').show('fast');
  })
  $('#delete').click(function () {
    //TODO use a better dialog
    if (confirm("Are you sure you want to delete this configuration?")) {
      $("#confirm_delete").val("1"); 
      return true;
    }
    return false;
  });

  {% if perms.config.can_approve %}
  // We want to make sure reviewers can see the comments
  $(".comment_list").show();
  $("#show").hide();
  {% endif %}

});
</script>
{% endblock %}

{% block heading %}Configuration: {{config.display_short_name}} {% endblock %}

{% block content %}

<h1>{{config.display_name}}
{% ifnotequal config.display_name config.display_short_name %} ({{config.display_short_name}} for short) {% endifnotequal %}
</h1>

{% if error %}
  <div id="errornote" class="errornote">
    <p>{{ error }}
  </div>
{% endif %}

<div class="configstatus {{ config.status }}">
  {% if config.status == 'approved' %}
  <div>This configuration is APPROVED.</div>
      {% if perms.config.can_approve %}
        <div>Is there a reason it shouldn't be?</div>
	<form action="{% url 'ispdb_approve' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            <input type="text" size="100" name="comment" value="Always enter a comment here"></input>
          </div>
          <div class="float">
            <input type="submit" value="mark invalid" name="denied"></input>
          </div>
        </form>
        <form action="{% url 'ispdb_delete' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            {% if confirm_delete %}
              <input id="confirm_delete" type="hidden" value="1" name="confirm_delete"></input>
              <input id="delete" type="submit" value="confirm delete" name="delete"></input>
            {% else %}
              <input id="confirm_delete" type="hidden" value="0" name="confirm_delete"></input>
              <input id="delete" type="submit" value="delete" name="delete"></input>
	    {% endif %}
          </div>
        </form>
      {% endif %}
  {% else %}
    {% if config.status == 'invalid' %}
    <div>
      This configuration has been determined INVALID.  We've looked at the
      data, and either it's not correct, or it can't be verified from outside
      the ISP's firewall, or the ISP has asked not to publish it.
    </div>
      {% if perms.config.can_approve %}
        <div>Is there a reason it shouldn't be?</div>
      	<form action="{% url 'ispdb_approve' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            <input type="text" size="100" name="comment" value="Always enter a comment here"></input>
          </div>
	  <div class="float">
            <input type="submit" value="mark valid" name="approved"></input>
          </div>
        </form>
        <form action="{% url 'ispdb_delete' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            {% if confirm_delete %}
              <input id="confirm_delete" type="hidden" value="1" name="confirm_delete"></input>
              <input id="delete" type="submit" value="confirm delete" name="delete"></input>
            {% else %}
              <input id="confirm_delete" type="hidden" value="0" name="confirm_delete"></input>
              <input id="delete" type="submit" value="delete" name="delete"></input>
	    {% endif %}
          </div>
        </form>
      {% endif %}
    {% else %}
      {% if perms.config.can_approve %}
        Can you confirm that this is a good configuration according to our <a href="{% url 'ispdb_policy' %}">policies</a>?
	<form action="{% url 'ispdb_approve' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            <input type="text" size="100" name="comment" value="Always enter a comment here"></input>
          </div>
          <div class="float">
            <input type="submit" value="yes, checks out ok" name="approved"></input>
            <input type="submit" value="no, there's a problem" name="denied"></input>
          </div>
        </form>
      {% else %}
        This configuration is PENDING REVIEW.  Our team of crack volunteers will review
	it, and assuming the data checks out, we'll publish it.
      {% endif %}
      {% if user == config.owner or perms.is_superuser %}
        <form action="{% url 'ispdb_delete' id=config.id %}" method="POST">{% csrf_token %}
          <div>
            {% if confirm_delete %}
              <input id="confirm_delete" type="hidden" value="1" name="confirm_delete"></input>
              <input id="delete" type="submit" value="confirm delete" name="delete"></input>
            {% else %}
              <input id="confirm_delete" type="hidden" value="0" name="confirm_delete"></input>
              <input id="delete" type="submit" value="delete" name="delete"></input>
	    {% endif %}
          </div>
        </form>
      {% endif %}
    {% endif %}
  {% endif %}
</div>

<h4>Domains Served</h4>
<div id="domains">
  {% if config.domains.all %}
    {% for domain in config.domains.all %}
      <div class="domain">{{domain}}</div>
    {% endfor %}
  {% else %}
    {% for domain in config.domainrequests.all %}
      <div class="domain">{{domain}}</div>
    {% endfor %}
  {% endif %}
</div>

<div id="server_data">
  <table>
    <tr>
      <td>
  <div id="incoming_data">
    <h4>Incoming Server</h4>
    <table>
      {% for field in incoming %}
      <tr>
        <td>{{ field.verbose_name|capfirst }}:</td><td>{{field|data_verbose}}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
      </td>
      <td>
  
  <div id="outoing_data">
    <h4>Outgoing Server</h4>
    <table>
      {% for field in outgoing %}
      <tr>
        <td>{{ field.verbose_name|capfirst }}:</td>
        <td>{{field|data_verbose}}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
    </td>
    </tr>
  </table>

</div>

<div id="other_data">
  <h4>Other Fields</h4>
  <table>
    {% for field in other_fields %}
    <tr>
      <td>{{ field.verbose_name|capfirst }}:</td><td>{{field.value}}</td>
    </tr>
    {% endfor %}
  </table>
</div>
</td>
<td>

<h4>View XML data</h4>

<p>See <a href="{% url 'ispdb_export_xml' version=1.1 id=config.id %}">XML version</a> (used by Thunderbird).</p>

<h3>Accurate?</h3>

<p>If you know the data above is not accurate, do let us know: 
<a href="{% url 'ispdb_edit' config.id %}">these parameters are out of date!</a>
</p>

<h3>Comments</h3>

{% load comments %}

{% get_comment_list for config as comment_list %}
{% if comment_list %}
<div id="previous_comments">
  <div id="show"><a>Show {{ comment_list|length }} existing comment{{comment_list|length|pluralize}}</a></div>
  <div class="comment_list hidden">
  {% for comment in comment_list %}
    <div class="comment">
      <span class="comment_author">{{comment.user_name}}</span> said: <span class="comment_contents">{{comment.comment}}</span>
    </div>
  {% endfor %}
  </div>
</div>
{% endif %}

<div id="add_a_comment">
  <div id="add"><a class="link">Add a comment</a></div>
  <div class="comment_form hidden">
    {% render_comment_form for config %}
  </div>
</div>

{% endblock %}
